@page "/chatbot"
@inject IChatBotService ChatBotService
@inject ILocalStorageService LocalStorage

<PageTitle>Health Chatbot</PageTitle>

<div class="container mt-4">
    <h2>ü§ñ Health Assistant</h2>
    <p class="text-muted">Ask about symptoms, get home remedies, or emergency help</p>
    
    <div class="row">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Chat with Health Assistant</h5>
                    <button class="btn btn-sm btn-light" @onclick="ClearChat">Clear Chat</button>
                </div>
                
                <div class="card-body chat-container" style="height: 400px; overflow-y: auto;" @ref="_chatContainer">
                    @foreach (var message in _chatHistory)
                    {
                        <div class="message @(message.IsUserMessage ? "user-message" : "bot-message")">
                            <div class="message-content">
                                @if (!message.IsUserMessage)
                                {
                                    <div class="bot-icon">ü§ñ</div>
                                }
                                <div class="message-text">
                                    @if (message.Message.Contains("**"))
                                    {
                                        @((MarkupString)message.Message.Replace("**", "<strong>").Replace("<strong>", "</strong>", message.Message.Count(c => c == '*') / 2))
                                    }
                                    else
                                    {
                                        @message.Message
                                    }
                                </div>
                            </div>
                            <small class="text-muted">@message.Timestamp.ToLocalTime().ToString("hh:mm tt")</small>
                        </div>
                    }
                </div>
                
                <div class="card-footer">
                    <div class="input-group">
                        <input @bind="_userMessage" @bind:event="oninput" 
                               class="form-control" placeholder="Type your message..." 
                               @onkeypress="HandleKeyPress" />
                        <button class="btn btn-success" @onclick="SendMessage" :disabled="_isSending">
                            @if (_isSending)
                            {
                                <span class="spinner-border spinner-border-sm" role="status"></span>
                            }
                            else
                            {
                                <span>Send</span>
                            }
                        </button>
                    </div>
                    
                    <div class="mt-2">
                        <small class="text-muted">Try: "I have a fever", "Set pill reminder", "Find a doctor"</small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card shadow">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Quick Actions</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-outline-info w-100 mb-2" @onclick="QuickAction('I have a fever')">
                        ü§í Fever Advice
                    </button>
                    <button class="btn btn-outline-info w-100 mb-2" @onclick="QuickAction('I need to set a pill reminder')">
                        üíä Set Reminder
                    </button>
                    <button class="btn btn-outline-info w-100 mb-2" @onclick="QuickAction('Find me a doctor nearby')">
                        üè• Find Doctor
                    </button>
                    <button class="btn btn-outline-danger w-100 mb-2" @onclick="QuickAction('Emergency help')">
                        üö® Emergency
                    </button>
                    <button class="btn btn-outline-success w-100" @onclick="QuickAction('Home remedies for cold')">
                        üè† Home Remedies
                    </button>
                </div>
            </div>
            
            @if (_currentResponse?.HomeRemedies?.Any() == true)
            {
                <div class="card shadow mt-3">
                    <div class="card-header bg-warning text-white">
                        <h5 class="mb-0">üè† Recommended Home Remedies</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush">
                            @foreach (var remedy in _currentResponse.HomeRemedies)
                            {
                                <li class="list-group-item">@remedy</li>
                            }
                        </ul>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<style>
    .chat-container {
        background-color: #f8f9fa;
        padding: 15px;
    }
    
    .message {
        margin-bottom: 15px;
        padding: 10px;
        border-radius: 10px;
        max-width: 80%;
    }
    
    .user-message {
        background-color: #007bff;
        color: white;
        margin-left: auto;
    }
    
    .bot-message {
        background-color: #e9ecef;
        color: #212529;
    }
    
    .message-content {
        display: flex;
        align-items: flex-start;
    }
    
    .bot-icon {
        margin-right: 10px;
        font-size: 1.2em;
    }
    
    .message-text {
        flex: 1;
    }
</style>

@code {
    private string _userMessage = "";
    private List<ChatHistory> _chatHistory = new List<ChatHistory>();
    private ChatResponse _currentResponse;
    private bool _isSending = false;
    private ElementReference _chatContainer;
    
    protected override async Task OnInitializedAsync()
    {
        await LoadChatHistory();
        // Send welcome message
        await SendWelcomeMessage();
    }
    
    private async Task LoadChatHistory()
    {
        var userId = await LocalStorage.GetItemAsync<string>("userId") ?? "default-user";
        _chatHistory = await ChatBotService.GetChatHistoryAsync(userId);
    }
    
    private async Task SendWelcomeMessage()
    {
        var welcomeMessage = new ChatHistory
        {
            UserId = "system",
            Message = "üëã Hello! I'm your Health Assistant. I can help you with:\n\n" +
                     "‚Ä¢ Setting pill reminders\n" +
                     "‚Ä¢ Providing home remedies\n" +
                     "‚Ä¢ Finding nearby doctors\n" +
                     "‚Ä¢ Emergency contacts\n\n" +
                     "How can I help you today?",
            Timestamp = DateTime.UtcNow,
            IsUserMessage = false
        };
        
        _chatHistory.Add(welcomeMessage);
        StateHasChanged();
    }
    
    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(_userMessage))
            return;
            
        _isSending = true;
        
        try
        {
            var userId = await LocalStorage.GetItemAsync<string>("userId") ?? "default-user";
            
            // Add user message to chat
            var userChat = new ChatHistory
            {
                UserId = userId,
                Message = _userMessage,
                Timestamp = DateTime.UtcNow,
                IsUserMessage = true
            };
            _chatHistory.Add(userChat);
            
            // Get bot response
            _currentResponse = await ChatBotService.ProcessMessageAsync(userId, _userMessage);
            
            // Add bot response to chat
            var botChat = new ChatHistory
            {
                UserId = userId,
                Message = _currentResponse.Message,
                Timestamp = DateTime.UtcNow,
                IsUserMessage = false,
                ResponseType = _currentResponse.Type
            };
            _chatHistory.Add(botChat);
            
            _userMessage = "";
            StateHasChanged();
            
            // Scroll to bottom
            await Task.Delay(100);
            await _chatContainer.FocusAsync();
        }
        catch (Exception ex)
        {
            // Handle error
        }
        finally
        {
            _isSending = false;
        }
    }
    
    private async Task QuickAction(string action)
    {
        _userMessage = action;
        await SendMessage();
    }
    
    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SendMessage();
        }
    }
    
    private async Task ClearChat()
    {
        _chatHistory.Clear();
        await SendWelcomeMessage();
    }
}
